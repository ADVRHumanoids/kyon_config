name: Build and Push Kyon Docker Images

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main

env:
  DOCKER_REGISTRY: hhcmhub
  TAG_NAME: ${{ github.ref_name }}

jobs:
  build-all-configurations:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        config:
          - name: "focal-ros1"
            env_file: "kyon-config_ros1.env"
            build_args: "--base --locomotion"
          - name: "focal-ros1-xeno"
            env_file: "kyon-config_ros1.env"
            build_args: "--xeno"
          - name: "noble-ros2"
            env_file: "kyon-config_ros2.env"
            build_args: "--base --locomotion"
          - name: "noble-ros2-xeno"
            env_file: "kyon-config_ros2.env"
            build_args: "--xeno"
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build ${{ matrix.config.name }} images
        run: |
          cd docker
          export TAGNAME=${{ env.TAG_NAME }}
          echo "Building ${{ matrix.config.name }} with tag: $TAGNAME"
          source ${{ matrix.config.env_file }} 
          export TAGNAME=${{ env.TAG_NAME }}  # Override again to restore GitHub's value becuase sourcing the env file might changed it
          ./build.bash ${{ matrix.config.build_args }}

      - name: Push ${{ matrix.config.name }} images (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          cd docker
          export TAGNAME=${{ env.TAG_NAME }}
          source ${{ matrix.config.env_file }}
          export TAGNAME=${{ env.TAG_NAME }}  # Override again to restore GitHub's value becuase sourcing the env file might changed it
          ./build.bash ${{ matrix.config.build_args }} --push